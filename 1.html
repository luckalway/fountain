<a href="#[cat_tag:namespace]top" id="[cat_tag:namespace]top"></a>
<div id="[cat_tag:namespace]message"></div>
<form id="[cat_tag:namespace]form" style="display:none;"></form>

<script type="text/javascript">
(function(){
  PROJECT.theme.skins.showSkinPortletLoading('[cat_tag:namespace]');

  var isCustomer = [cat_tag:namespace]CustomerPortalUserAttributes.customer == 'true';
  var formElements = {};
  var form = $('#[cat_tag:namespace]form');

  PROJECT.template.outPutHTML($('<p>'+catPortalNLSJSON.scheduleServiceHeader+'</p>'), form);

  var filtersJSON = JSON.parse(PROJECT.utility.getUrlParameter('filtersJSON'));
  var asset = JSON.parse(PROJECT.utility.getUrlParameter('asset'));

  var alertsTable;
  var loadDealerDeferred = $.Deferred(), loadAlertsDeferred = $.Deferred();

  var serialNumber = asset.serialNumber || '';
  var assetId = asset.assetId || '';
  var make = asset.make || '';
  make = make.toUpperCase() == 'CAT'?'CATERPILLAR':make;
  var product = asset.product.label || '';
  var model = asset.model || '';
  var manufacturerCode = asset.manufacturerCode || '';
  var sampleId = parseInt(PROJECT.utility.getUrlParameter('sampleId'));
  var dealerCode = '';

  function createLabelValueRow(label, value){
    return '<tr><td><div>' + label + ': </div></td><td class="verticalTableCol1">' + value + '</td></tr>';
  }

  PROJECT.template.outPutHTML($('<table class="margin-bottom-10"><tbody>' + createLabelValueRow(catPortalNLSJSON.snTxt, serialNumber)
  + createLabelValueRow(catPortalNLSJSON.assetIdTxt, assetId)
  + createLabelValueRow(catPortalNLSJSON.makeTxt, make)
  + createLabelValueRow(catPortalNLSJSON.productTxt, product)
  + createLabelValueRow(catPortalNLSJSON.modelTxt, model) + '</tbody></table>'), form);

  PROJECT.template.getSectionTitle({
    text : catPortalNLSJSON.appointmentPreferencesLabelTxt,
    appendTo : form
  });

  PROJECT.template.outPutHTML($('<p>'+catPortalNLSJSON.appointmentPreferencesHeaderTxt+'</p>'),form);

  formElements.preferredDate = PROJECT.template.formRow({
    ns : '[cat_tag:namespace]',
    text : catPortalNLSJSON.preferredDateTxt,
    type : 'datepicker',
    id : 'preferredDate',
    value : new Date(),
    appendTo : form,
    startDate : PROJECT.datepicker.getDate(new Date()).jsDate
  });

  formElements.preferredTime = PROJECT.template.formRow({
    ns : '[cat_tag:namespace]',
    text : catPortalNLSJSON.preferredTimeTxt,
    type : 'timepicker',
    id : 'preferredTime',
    defaultTime: '7:00',
    startTime: '5:00',
    appendTo : form,
    layout : PROJECT.template.FORM_LAYOUT.FULLPAGE
  });

  var dealerContainer = $('<div id="[cat_tag:namespace]dealerContainer"></div>');
  PROJECT.template.outPutHTML(dealerContainer, form);

  PROJECT.template.getSectionTitle({
    text : catPortalNLSJSON.confirmatonPreferencesLabelTxt,
    appendTo : form
  });

  PROJECT.template.outPutHTML($('<p>'+catPortalNLSJSON.servicerequestForm_ConfirmationPrefBodyCopy+'</p>'), form);

  formElements.contactName = PROJECT.template.formRow({
    ns : '[cat_tag:namespace]',
    text : catPortalNLSJSON.contactNameTxt,
    value : catCustomerPortalUserAttributes.displayName,
    id : 'contactName',
    appendTo : form,
    rules : {
      required : true,
      maxlength : 100
    },
    messages : {
      required : catPortalNLSJSON.contactNameValidationTxt
    }
  });

  var phoneContainer = $('<div id="[cat_tag:namespace]phoneContainer"></div>');
  PROJECT.template.outPutHTML(phoneContainer, form);

  var phoneWithPrefixMatch = /\+(\d+)\s+(.+)/.exec(catCustomerPortalUserAttributes.telephoneNumber);
  formElements.contactPhone = PROJECT.template.formRow({
    ns : '[cat_tag:namespace]',
    id : 'contactPhone',
    type: 'phone',
    selectedPhonePrefix: phoneWithPrefixMatch?phoneWithPrefixMatch[1]:undefined,
    phoneValue: phoneWithPrefixMatch?phoneWithPrefixMatch[2]:catCustomerPortalUserAttributes.telephoneNumber,
    onlyPhone: false,
    rulesForm : form,
    appendTo : phoneContainer,
    rules : {
      required : true,
      maxlength: 100
    },
    messages : {
      required : catPortalNLSJSON.enterValidPhoneNumberTxt,
    }
  });

  var alternatePhoneContainer = $('<div id="[cat_tag:namespace]alternatePhoneContainer"></div>');
  PROJECT.template.outPutHTML(alternatePhoneContainer, form);

  var addPhoneLink = $('<a href="javascript:void(0);">'+catPortalNLSJSON.phoneNumTxt+'</a>');
  addPhoneLink.click(function(){
    if(addPhoneLink.html()==catPortalNLSJSON.removeTxt){
      alternatePhoneContainer.empty();
      addPhoneLink.html(catPortalNLSJSON.phoneNumTxt);
    }else{
      formElements.altContactPhone = PROJECT.template.formRow({
        ns : '[cat_tag:namespace]',
        id : 'altContactPhone',
        type: 'phone',
        onlyPhone: false,
        alternate: true,
        selectedPhonePrefix : formElements.contactPhone.getPhoneObject().phonePrefix.val(),
        rulesForm : form,
        appendTo : alternatePhoneContainer,
        rules : {
          required : true,
          maxlength: 100
        },
        messages : {
          required : catPortalNLSJSON.enterValidPhoneNumberTxt,
        }
      });
      addPhoneLink.html(catPortalNLSJSON.removeTxt);
    }
  });
  var addPhoneLinkDIV = $('<div id="[cat_tag:namespace]addPhoneLinkDIV" class="row-fluid"></div>');
  PROJECT.template.outPutHTML(addPhoneLinkDIV, form);
  PROJECT.template.outPutHTML(addPhoneLink, addPhoneLinkDIV);

  formElements.method = PROJECT.template.formRow({
    ns : '[cat_tag:namespace]',
    text : catPortalNLSJSON.methodTxt,
    id : 'method',
    appendTo : form,
    type : 'select',
    placeholder: catPortalNLSJSON.selectTxt,
    select : [ {
      value : 'Call',
      text : catPortalNLSJSON.callTxt
    }, {
      value : 'Text',
      text : catPortalNLSJSON.textTxt
    }, {
      value : 'Email',
      text : catPortalNLSJSON.emailTxt
    }  ],
    rules : {
      required : true,
    },
    messages:{
      required:catPortalNLSJSON.contactMethodValidationTxt}
    });

    var emailsContainer = $('<div></div>')
    PROJECT.template.outPutHTML(emailsContainer, form);

    formElements.contactEmail = PROJECT.template.formRow({
      ns : '[cat_tag:namespace]',
      text : catPortalNLSJSON.emailTxt,
      value : catCustomerPortalUserAttributes.mail,
      id : 'contactEmail',
      appendTo : emailsContainer,
      rulesForm: form,
      rules : {
        required : true,
        email : true,
        maxlength : 100
      },
      messages : {
        required : catPortalNLSJSON.emailFormatValidationTxt
      }
    });

    var addEmailLink = $('<a href="javascript:void(0)">'+catPortalNLSJSON.addAnotherEmailTxt+'</a>');
    var removeEmailLink = $('<a href="javascript:void(0)" style="display:none;">' + catPortalNLSJSON.removeTxt + '</a>');
    addEmailLink.click(function(){
      formElements.altContactEmail = PROJECT.template.formRow({
        ns : '[cat_tag:namespace]',
        text : catPortalNLSJSON.alternateEmailTxt,
        id : 'altContactEmail',
        appendTo : emailsContainer,
        rulesForm: form,
        rules : {
          required : true,
          email : true,
          maxlength : 100
        },
        messages : {
          required : catPortalNLSJSON.emailFormatValidationTxt
        }
      });
      addEmailLink.hide();
      removeEmailLink.show();
    });

    removeEmailLink.click(function(){
      formElements.altContactEmail.parentsUntil(emailsContainer,'.row').remove();
      formElements.altContactEmail = undefined;
      addEmailLink.show();
      removeEmailLink.hide();
    });

    PROJECT.template.outPutHTML(addEmailLink, form);
    PROJECT.template.outPutHTML(removeEmailLink, form);

    PROJECT.template.getSectionTitle({
      text : catPortalNLSJSON.alertsTxt,
      appendTo : form
    }).html(catPortalNLSJSON.alertsTxt + '<span class="cat-required-label">*</span>');

    PROJECT.template.outPutHTML($('<p>' + catPortalNLSJSON.sosAlertsSectionInformationTxt + '</p>'), form);
    var alertsErrorLabel = $('<label class="cat-error-text" style="display: none;">'+catPortalNLSJSON.selectOneOrMoreSOSResultTxt+'</label>');

    formElements.checkForAlertsSelect = PROJECT.template.formRow({
      ns : '[cat_tag:namespace]',
      text : '',
      id : 'checkForAlertsSelect',
      appendTo : form,
      rules : {
        required : true
      },
      messages : {
        required : catPortalNLSJSON.selectOneOrMoreSOSResultTxt
      }
    });

    formElements.checkForAlertsSelect.hide();
    formElements.checkForAlertsSelect.siblings('[for=[cat_tag:namespace]checkForAlertsSelect]').hide();

    var alertsDatatableContainer = $('<div class="margin-bottom-15"></div>')
    PROJECT.template.outPutHTML(alertsDatatableContainer, form);

    PROJECT.template.outPutHTML($('<div class="clear"></div>'), form);

    formElements.serviceLocation = PROJECT.template.formRow({
      ns : '[cat_tag:namespace]',
      text : catPortalNLSJSON.serviceLocationTxt,
      id : 'serviceLocation',
      appendTo : form,
      rules : {
        required : true
      },
      messages : {
        required : catPortalNLSJSON.textAreaValidationTxt
      }
    });

    PROJECT.template.outPutHTML($('<p>'+catPortalNLSJSON.servicerequestForm_describeServiceBodyCopy+'</p>'), form);

    formElements.locationDescription = PROJECT.template.formRow({
      ns : '[cat_tag:namespace]',
      id : 'locationDescription',
      type: 'textarea',
      appendTo : form
    });


    var selectAllCheckboxDiv = $('<div>');
    PROJECT.template.formRow({
      ns : '[cat_tag:namespace]',
      id : 'selectAll',
      type : 'checkbox',
      appendTo : selectAllCheckboxDiv
    });

    var eventTable = $('<div id="[cat_tag:namespace]alertsDatatable">'+
    '<div id="[cat_tag:namespace]alertsDatatableTemplate">'+
    '<table id="[cat_tag:namespace]ServiceTableTemplate" class="dataTable">'+
    '<thead>'+
    '<tr>'+
    '<th class="all">' + selectAllCheckboxDiv.html() + '</input></th>'+
    '<th class="all">'+catPortalNLSJSON.labNoTxt+'</th>'+
    '<th class="all">'+catPortalNLSJSON.dateTxt+'</th>'+
    '<th class="none">'+catPortalNLSJSON.componentTxt+'</th>'+
    '<th class="none">'+catPortalNLSJSON.descriptionTxt+'</th>'+
    '</tr>'+
    '</thead>'+
    '<tbody></tbody>'+
    '</table>'+
    '</div>'+
    '</div>');
    PROJECT.template.outPutHTML(eventTable,alertsDatatableContainer);

    var alertsTableConfig = {
      catNotSearch : true,
      catNotExport : true,
      catIsBottomBorder : true,
      ordering: false,
      columns : [
        {
          data: 'sampleId',
          render:function(val, type, row, meta){
            var checkDiv = $('<div>');
            PROJECT.template.formRow({
              ns : '[cat_tag:namespace]',
              id : 'checkbox'+ meta.row,
              type : 'checkbox',
              value: val == sampleId,
              appendTo : checkDiv
            });
            return checkDiv.html();
          },
          createdCell: function (td, cellData, rowData, row, col) {
            $(td).closest('tr').addClass('cat-clickable-row');
          },
          orderable: false,
        }, {
          data:'labNumber',
          orderable: false
        }, {
          data: 'date.display',
          orderable: false
        }, {
          data:'component',
          orderable: false
        },
        {
          data:'description',
          orderable: false
        }
      ],
      language: {
        emptyTable:catPortalNLSJSON.noSOSTxt,
        zeroRecords: catPortalNLSJSON.noSOSTxt
      },
    }

    //loading alerts
    var contextForGettingAlerts = '/' + filtersJSON.date_range_filters.from_date + '/' + filtersJSON.date_range_filters.to_date+'/SOS?format=json';
    contextForGettingAlerts += '&aem_code='+manufacturerCode+'&serial_number=' + serialNumber + '&healthRating='+JSON.stringify(filtersJSON.rating);
    if(!isCustomer){
      contextForGettingAlerts += '&customer_id=[cat_tag:customer_id_object_attribute name="customerId"]&ucid=[cat_tag:customer_id_object_attribute name="ucid"]'
    }

    var params = {};
    params["context"] = encodeURIComponent(contextForGettingAlerts);
    params["method"] = 'GET';
    [cat_tag:namespace]CallServicePortletResourceURL('custPortalServiceRequestAlertsGet', null,
    function(resultStr){
      var result = JSON.parse(resultStr);
      var alerts = result.sosScheduleService;
      alerts.sort(function(a1, a2){
        var getRanking  = function(a){
          var ranking = a.sampleId == sampleId?0:10;
          if(a.emergency == 'RED'){
            ranking += 1;
          }else if(a.emergency == 'YELLOW'){
            ranking += 2;
          }else if(a.emergency ==  'GRAY'){
            ranking += 3;
          }
          return ranking;
        }

        var r1 = getRanking(a1);
        var r2 = getRanking(a2)
        if(r1==r2){
          return a2.date.milliseconds - a1.date.milliseconds;
        }
        return r1 - r2;
      });
      alertsTableConfig.data = alerts;
      alertsTable = PROJECT.dataTable.draw($('#[cat_tag:namespace]ServiceTableTemplate'), '[cat_tag:namespace]', alertsTableConfig);
      if(alerts.length == 1){
        $('#[cat_tag:namespace]selectAll').prop("checked", true);
      }

      $('#[cat_tag:namespace]alertsDatatable').find('tr th:first-child').removeClass('text-right');
      var $alertsDatatableBody = $('#[cat_tag:namespace]alertsDatatable tbody');
      $alertsDatatableBody.find('tr td:first-child').removeClass('text-right');
      $('#[cat_tag:namespace]selectAll').parentsUntil('th', '.columns').find('label').css('overflow','visible');

      $('#[cat_tag:namespace]selectAll').click(function() {
        $alertsDatatableBody.find('input:checkbox').prop("checked", this.checked);
        $alertsDatatableBody.find('input:checkbox').change();
      });

      $alertsDatatableBody.on('change', 'input:checkbox', function(){
        $alertsDatatableBody.find('input:checked').parentsUntil('tbody','tr').addClass('selected');
        $alertsDatatableBody.find('input:checkbox:not(:checked)').parentsUntil('tbody','tr').removeClass('selected');
        var sizeOfChecked = $alertsDatatableBody.find('input:checked').length;
        if(sizeOfChecked != 0){
          formElements.checkForAlertsSelect.val('alerts selected');
          formElements.checkForAlertsSelect.click();
          formElements.checkForAlertsSelect.blur();
        }else{
          formElements.checkForAlertsSelect.val('');
        }
      });
      $alertsDatatableBody.find('input:checkbox').change();
      alertsTable.on('draw',function(){
        $('#[cat_tag:namespace]selectAll').parentsUntil('th', '.columns').find('label').css('overflow','visible');
        $('#[cat_tag:namespace]alertsDatatable').find('tr th:first-child').removeClass('text-right');
        $('#[cat_tag:namespace]alertsDatatable').find('tr td:first-child').removeClass('text-right');
      })
      loadAlertsDeferred.resolve();
    },  function(statusCode){
      PROJECT.theme.skins.hideSkinPortletLoading('[cat_tag:namespace]');
      form.show();
      PROJECT.theme.skins.messages.setDivGenericError('[cat_tag:namespace]message');
      document.getElementById('[cat_tag:namespace]top').click();
    }, params);

    formElements.buttons = PROJECT.template.formRow({
      ns : '[cat_tag:namespace]',
      layout : 'centered',
      list : [ {
        text : catPortalNLSJSON.cancelButtonTxt,
        type : 'button',
        role : 'secondary'
      }, {
        text : catPortalNLSJSON.submitButtonTxt,
        type : 'submit',
        role : 'primary'
      } ],
      appendTo : form,
    });

    formElements.buttons[1].on('click.temp', function(e){
      e.stopImmediatePropagation();
      return false;
    });

    $.when(loadDealerDeferred, loadAlertsDeferred).then(function(){
      PROJECT.theme.skins.hideSkinPortletLoading('[cat_tag:namespace]');
      form.show();

      formElements.buttons[1].off('click.temp').on('click', function(e) {
        if(!isCustomer){
          PROJECT.theme.skins.messages.setDivError('[cat_tag:namespace]message', catPortalNLSJSON.vaildCustomerUserErrorMessageTxt);
          document.getElementById('[cat_tag:namespace]top').click();
          e.stopImmediatePropagation();
          return false;
        }

        if(isCustomer){
          PROJECT.validation.validate(form, function(form){
            submitForm();
          });
        }
        return true;
      });
    });

    // loading dealers
    var params = {};
    var context = '?format=json&aem_cd='+ manufacturerCode +'&serial_number=' + serialNumber;
    params["method"] = 'GET';
    [cat_tag:namespace]CallServicePortletResourceURL('custPortalServiceRequestDealerSelectionGet', encodeURIComponent(context),
    function(dealers){
      loadDealerDeferred.resolve();
      dealers = JSON.parse(dealers);
      if(dealers.length==0){
        return;
      }

      if(dealers.length==1){
        dealerCode = dealers[0].value;
        PROJECT.template.outPutHTML($('<div class="row"><label>'+catPortalNLSJSON.dealerTxt+'</label></div>'), dealerContainer);
        PROJECT.template.outPutHTML($('<div class="row-fluid">'+dealers[0].text+'</div>'), dealerContainer);
        return;
      }

      formElements.dealer = PROJECT.template.formRow({
        ns : '[cat_tag:namespace]',
        text : catPortalNLSJSON.dealerTxt,
        id : 'dealer',
        appendTo : dealerContainer,
        type : 'select',
        select : dealers,
        selected : dealers[0].dealerCode
      });
    },  function(statusCode){
      PROJECT.theme.skins.hideSkinPortletLoading('[cat_tag:namespace]');
      form.show();
      PROJECT.theme.skins.messages.setDivGenericError('[cat_tag:namespace]message');
      document.getElementById('[cat_tag:namespace]top').click();
    }, params);

    function submitForm(){
      parent.PROJECT.dialog.setLoadingFrame(true);
      PROJECT.theme.skins.showSkinPortletLoading('[cat_tag:namespace]');

      var sosResultInfos = [];
      var selectedRows = alertsTable.rows('.selected').data();
      for (var i = 0; i < selectedRows.length; i++) {
        sosResultInfos.push({
          component: selectedRows[i].component,
          sosLab: selectedRows[i].labNumber,
          description: selectedRows[i].description
        });
      }

      if($('#[cat_tag:namespace]dealer').length > 0){
        dealerCode = $('#[cat_tag:namespace]dealer').val();
      }

      var sosServiceRequest =  {
        preferredTime: formElements.preferredTime.val(),
        preferredDate:formElements.preferredDate.val(),
        contactName : formElements.contactName.val(),
        contactPhone : formElements.contactPhone.getPhoneObject().phonePrefix.val()+" "+formElements.contactPhone.val(),
        contactEmail : formElements.contactEmail.val(),
        altContactPhone : formElements.altContactPhone ? formElements.altContactPhone.getPhoneObject().phonePrefix.val()+" "+formElements.altContactPhone.val() : '',
        altContactEmail : formElements.altContactEmail?formElements.alternateEmail.val():'',
        preferredContactMethod : formElements.method.val(),
        serviceLocation: formElements.serviceLocation.val(),
        comments: formElements.locationDescription.val(),
        sosResultInfos: sosResultInfos
      }

      var params = {};
      params["context"] = '?format=json';
      params["method"] = 'POST';
      params["form_param_json"] = {sosServiceRequest: JSON.stringify(sosServiceRequest),
        aemCode: manufacturerCode,
        serialNumber: serialNumber,
        dealerCode: dealerCode
      }
      [cat_tag:namespace]CallServicePortletResourceURL('custPortalSOSServiceRequestPost', null,
      function(response){
        PROJECT.theme.skins.hideSkinPortletLoading('[cat_tag:namespace]');
      }, function(statusCode){
        PROJECT.theme.skins.hideSkinPortletLoading('[cat_tag:namespace]');
        parent.PROJECT.dialog.setLoadingFrame(false);
        PROJECT.theme.skins.messages.setDivGenericError('[cat_tag:namespace]message');
        document.getElementById('[cat_tag:namespace]top').click();
      }, params);
    }

  })();
  </script>
